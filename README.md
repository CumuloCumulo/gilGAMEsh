# 语雀增强导出 (Yuque Enhanced Export)

一键导出语雀文档到 Obsidian，自动下载并替换视频链接。

## ✨ 功能特性

- 🚀 **一键导出**：自动化语雀的导出流程，无需手动操作
- 🎥 **视频处理**：自动识别文档中的视频卡片，下载视频文件并替换占位符
- 📁 **直接保存**：使用 File System Access API 直接保存到 Obsidian 仓库
- 🔄 **完整迁移**：Markdown 文档 + 视频文件 + 目录结构一次性完成
- 📊 **详细日志**：每个步骤都有详细的日志输出，方便排查问题

## 🎯 解决的问题

语雀的原生导出功能存在以下问题：

1. **视频丢失**：导出的 Markdown 中视频显示为占位符 `[此处为语雀卡片，点击链接查看](about:blank#xxx)`
2. **手动下载**：需要手动下载视频文件
3. **链接替换**：需要手动替换 Markdown 中的视频占位符
4. **重复操作**：每次导出都需要重复上述步骤

本插件自动完成整个流程，让导出变得简单。

## 📦 安装方法

### 方法一：开发者模式安装（推荐）

1. 下载本项目代码
   ```bash
   git clone https://github.com/your-repo/yuque-enhanced-export.git
   cd yuque-enhanced-export
   ```

2. 打开 Chrome 浏览器，进入扩展管理页面
   - 访问 `chrome://extensions/`
   - 或点击右上角 ⋮ → 更多工具 → 扩展程序

3. 启用「开发者模式」（右上角开关）

4. 点击「加载已解压的扩展程序」

5. 选择项目文件夹

### 方法二：Chrome Web Store（待上线）

暂未发布到商店。

## 🚀 使用方法

### 1. 首次使用：设置 Obsidian 仓库

1. 打开任意语雀文档页面
2. 页面标题旁会出现两个按钮：
   - 🟠 **设置 Obsidian 仓库**
   - 🔵 **一键导出到 Obsidian**
3. 点击「设置 Obsidian 仓库」
4. 在弹出的文件选择器中选择你的 Obsidian 仓库文件夹
5. 授予读写权限

> 💡 **提示**：仓库路径会保存在浏览器中，下次使用无需重新设置

### 2. 导出文档

1. 打开要导出的语雀文档
2. 点击「一键导出到 Obsidian」按钮
3. 等待自动执行以下步骤：
   - ✅ 触发语雀导出菜单
   - ✅ 选择 Markdown 格式
   - ✅ 监听浏览器下载
   - ✅ 提取文档中的视频链接
   - ✅ 下载所有视频文件
   - ✅ 替换 Markdown 中的视频占位符
   - ✅ 保存到 Obsidian 仓库
4. 看到「导出完成」提示

### 3. 查看结果

在你的 Obsidian 仓库中会看到：

```
你的仓库/
├── 文档标题.md          # Markdown 文件
└── videos/              # 视频文件夹
    ├── SB2px.mp4
    ├── f78vB.mp4
    └── ...
```

Markdown 中的视频占位符已被替换为：
```markdown
![video](videos/SB2px.mp4)
```

## 🔧 技术实现

### 核心技术

- **File System Access API**：直接访问本地文件系统，无需下载管理
- **Chrome Downloads API**：监听浏览器下载事件
- **DOM 自动化**：模拟用户操作，自动化导出流程
- **消息传递**：Background Script 和 Content Script 通信

### 工作流程

```
用户点击导出按钮
        ↓
1. 查找左侧目录中选中的文档
        ↓
2. 模拟鼠标悬停，显示操作按钮
        ↓
3. 点击"三个点"按钮
        ↓
4. 点击"导出..."菜单项
        ↓
5. 选择 Markdown 格式
        ↓
6. 点击"导出"按钮
        ↓
7. Background Script 监听浏览器下载
        ↓
8. 等待下载完成
        ↓
9. 获取下载文件的 URL
        ↓
10. 从 URL 读取 Markdown 内容
        ↓
11. 扫描 DOM 收集视频卡片
        ↓
12. 替换 Markdown 中的视频占位符
        ↓
13. 保存 Markdown 到 Obsidian
        ↓
14. 逐个下载视频文件
        ↓
15. 保存视频到 videos/ 目录
        ↓
✅ 完成
```

### 关键挑战与解决方案

| 挑战 | 解决方案 |
|------|----------|
| 语雀的"导出"按钮需要鼠标悬停才显示 | 模拟 `mouseenter` 事件显示按钮 |
| 语雀触发浏览器直接下载，页面无下载链接 | 使用 Downloads API 监听下载事件 |
| Content Script 无法直接访问 Downloads API | 通过消息传递与 Background Script 通信 |
| 视频 URL 带认证参数，有时效性 | 立即下载，不延迟处理 |
| File System Access API 权限持久化 | 使用 IndexedDB 保存文件句柄 |

## 🐛 常见问题

### Q1: 点击导出按钮后没有反应？

**可能原因：**
- 未设置 Obsidian 仓库
- 权限已过期

**解决方法：**
1. 检查是否已点击「设置 Obsidian 仓库」
2. 如果已设置，点击「重置 Obsidian 仓库」重新设置
3. 确保授予了读写权限

### Q2: 提示"未找到语雀的导出菜单按钮"？

**可能原因：**
- 页面未完全加载
- 左侧目录未显示
- 文档权限不足

**解决方法：**
1. 刷新页面后重试
2. 确保左侧目录可见
3. 确认当前账号有导出权限

### Q3: 导出的文档只有几行，内容不完整？

**可能原因：**
- 误抓取了错误的下载链接
- 下载的是 ZIP 文件但插件未处理

**解决方法：**
1. 检查控制台日志，查看下载的 URL
2. 如果是 ZIP 文件，暂时需要手动解压

### Q4: 视频没有下载？

**可能原因：**
- 视频链接已过期
- 网络问题

**解决方法：**
1. 查看控制台日志，确认是否找到视频
2. 检查 `[Video]` 标签的日志输出
3. 手动在语雀页面右键视频保存

### Q5: 提示"语雀导出为ZIP格式"？

**当前限制：**
- 插件暂不支持自动解压 ZIP 文件

**临时方案：**
1. 手动解压下载的 ZIP 文件
2. 将 Markdown 文件拖入浏览器页面处理

## 📊 调试信息

插件提供了详细的控制台日志，按 `F12` 打开开发者工具查看：

### 日志标签说明

- `[Main]` - 主导出流程
- `[Export]` - 语雀自动导出
- `[Download]` - 浏览器下载监听
- `[Video]` - 视频收集
- `[Replace]` - 内容替换
- `[Save]` - 文件保存
- `[Wait]` - 元素等待

### 成功示例

```
[Main] 开始导出到Obsidian流程
[Export] 开始自动导出流程
[Export] ✓ 找到选中的文档项
[Export] ✓ 找到三个点按钮
[Export] ✓ 找到导出菜单项
[Export] ✓ 找到Markdown选项
[Export] ✓ 找到导出确认按钮
[Download] ✓ 收到下载完成通知: 庄永琪.md
[Video] ✓ 收集完成，共 5 个有效视频
[Replace] ✓ 替换完成，共替换 5/5 个占位符
[Save] ✓ 文件已保存: 庄永琪.md
[Download] ✓ 下载完成: SB2px.mp4, 大小: 12.34MB
[Main] ✓✓✓ 导出完成！总耗时: 15.6秒
```

## 🛠️ 开发说明

### 项目结构

```
gilGAMEsh/
├── manifest.json        # 扩展配置
├── background.js        # Background Service Worker
├── content.js          # Content Script（主要逻辑）
├── icons/              # 图标资源
│   ├── icon16.png
│   ├── icon48.png
│   └── icon128.png
└── README.md           # 本文档
```

### 开发环境

- Chrome 浏览器 88+
- 支持 File System Access API
- 支持 Manifest V3

### 本地开发

1. 修改代码后，在扩展管理页面点击刷新图标
2. 打开控制台查看日志
3. 重新加载语雀页面测试

### 添加新功能

1. **修改 content.js**：主要业务逻辑
2. **修改 background.js**：下载监听等后台任务
3. **更新 manifest.json**：如需新权限

## 📝 TODO

- [ ] 支持 ZIP 文件自动解压
- [ ] 支持批量导出（整个知识库）
- [ ] 支持自定义视频链接格式
- [ ] 支持导出历史记录
- [ ] 添加配置页面
- [ ] 支持其他格式（PDF、Word）

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📄 许可证

MIT License

## 👨‍💻 作者

[Your Name]

## 🙏 致谢

- 感谢语雀团队提供优秀的文档平台
- 感谢 Obsidian 社区的支持

---

**⭐ 如果觉得有用，请给个 Star！**
